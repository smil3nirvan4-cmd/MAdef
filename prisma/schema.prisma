generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Cuidador {
  id           String     @id @default(cuid())
  telefone     String     @unique
  nome         String?
  area         String?
  status       String     @default("CRIADO")
  quizScore    Int?
  scoreRH      Int?
  competencias String?
  endereco     String?
  deletedAt    DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  alocacoes    Alocacao[]
  mensagens    Mensagem[]
}

model Paciente {
  id         String               @id @default(cuid())
  telefone   String               @unique
  nome       String?
  cidade     String?
  bairro     String?
  tipo       String               @default("HOME_CARE")
  hospital   String?
  quarto     String?
  status     String               @default("LEAD")
  prioridade String               @default("NORMAL")
  gqpScore   Int?
  deletedAt  DateTime?
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
  alocacoes  Alocacao[]
  avaliacoes Avaliacao[]
  mensagens  Mensagem[]
  orcamentos Orcamento[]
  simulacoes OrcamentoSimulacao[]
}

model Mensagem {
  id         String    @id @default(cuid())
  telefone   String
  direcao    String
  conteudo   String
  flow       String?
  step       String?
  timestamp  DateTime  @default(now())
  cuidadorId String?
  pacienteId String?
  paciente   Paciente? @relation(fields: [pacienteId], references: [id])
  cuidador   Cuidador? @relation(fields: [cuidadorId], references: [id])
}

model Avaliacao {
  id              String    @id @default(cuid())
  pacienteId      String
  abemidScore     Int?
  katzScore       Int?
  lawtonScore     Int?
  gqp             Int?
  nivelSugerido   String?
  cargaSugerida   String?
  nivelFinal      String?
  cargaFinal      String?
  avaliadorId     String?
  validadoEm      DateTime?
  status          String    @default("PENDENTE")
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  paciente        Paciente  @relation(fields: [pacienteId], references: [id])
  dadosDetalhados String? // JSON com discovery, patient, clinical, abemid, etc

  // Campos de rastreamento WhatsApp
  whatsappEnviado    Boolean              @default(false)
  whatsappEnviadoEm  DateTime?
  whatsappMessageId  String?
  whatsappErro       String?
  whatsappTentativas Int                  @default(0)
  valorProposto      String?
  orcamentos         Orcamento[]
  simulacoes         OrcamentoSimulacao[]
}

model Orcamento {
  id                    String                     @id @default(cuid())
  pacienteId            String
  unidadeId             String?
  configVersionId       String?
  avaliacaoId           String?
  cenarioEconomico      String?
  cenarioRecomendado    String?
  cenarioPremium        String?
  cenarioSelecionado    String?
  valorFinal            Float?
  snapshotInput         String?
  snapshotOutput        String?
  planningInput         String?
  normalizedSchedule    String?
  pricingBreakdown      String?
  calculationHash       String?
  auditHash             String?
  engineVersion         String?
  createdBy             String?
  descontoManualPercent Float?
  minicustosDesativados String?
  moeda                 String                     @default("BRL")
  status                String                     @default("RASCUNHO")
  aprovadoPor           String?
  enviadoEm             DateTime?
  aceitoEm              DateTime?
  deletedAt             DateTime?
  createdAt             DateTime                   @default(now())
  paciente              Paciente                   @relation(fields: [pacienteId], references: [id])
  unidade               Unidade?                   @relation(fields: [unidadeId], references: [id])
  configVersion         UnidadeConfiguracaoVersao? @relation(fields: [configVersionId], references: [id])
  avaliacao             Avaliacao?                 @relation(fields: [avaliacaoId], references: [id])
  simulacoes            OrcamentoSimulacao[]
  auditLogs             OrcamentoAuditLog[]

  @@index([pacienteId, createdAt])
  @@index([unidadeId, createdAt])
  @@index([configVersionId])
  @@index([avaliacaoId])
  @@index([calculationHash])
  @@index([auditHash])
}

model Alocacao {
  id            String    @id @default(cuid())
  cuidadorId    String
  pacienteId    String?
  slotId        String
  turno         String
  diaSemana     Int
  dataInicio    DateTime
  hospital      String?
  quarto        String?
  status        String    @default("PENDENTE_FEEDBACK")
  ofertadoEm    DateTime  @default(now())
  respondidoEm  DateTime?
  confirmadoT24 DateTime?
  confirmadoT2  DateTime?
  deletedAt     DateTime?
  createdAt     DateTime  @default(now())
  paciente      Paciente? @relation(fields: [pacienteId], references: [id])
  cuidador      Cuidador  @relation(fields: [cuidadorId], references: [id])
}

model FormSubmission {
  id        String   @id @default(cuid())
  tipo      String
  dados     String
  telefone  String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
}

model WhatsAppSession {
  id             String           @id @default(cuid())
  phone          String?          @unique
  contactId      String?          @unique
  state          String           @default("MENU")
  data           String?
  expiresAt      DateTime?
  status         String           @default("DISCONNECTED")
  qrCode         String?
  connectedAt    DateTime?
  disconnectedAt DateTime?
  lastActivity   DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  contact        WhatsAppContact? @relation("ContactSession", fields: [contactId], references: [id])
}

model WhatsAppFlowState {
  id              String   @id @default(cuid())
  phone           String   @unique
  currentFlow     String   @default("IDLE")
  currentStep     String   @default("")
  data            String
  lastInteraction DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model WhatsAppLock {
  id         String   @id @default(cuid())
  resourceId String   @unique
  ownerId    String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
}

model WhatsAppCooldown {
  id        String   @id @default(cuid())
  key       String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model WhatsAppContact {
  id          String            @id @default(cuid())
  phone       String            @unique
  name        String?
  jid         String?
  profilePic  String?
  isBlocked   Boolean           @default(false)
  labels      String?
  lastMessage DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  messages    WhatsAppMessage[]
  session     WhatsAppSession?  @relation("ContactSession")
}

model WhatsAppMessage {
  id        String          @id @default(cuid())
  contactId String
  direction String
  type      String
  content   String
  mediaUrl  String?
  status    String          @default("sent")
  metadata  String?
  createdAt DateTime        @default(now())
  contact   WhatsAppContact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([contactId, createdAt])
}

model WhatsAppTemplate {
  id        String   @id @default(cuid())
  name      String   @unique
  category  String
  content   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WhatsAppQuickReply {
  id        String   @id @default(cuid())
  shortcut  String   @unique
  content   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WhatsAppAutoReply {
  id        String   @id @default(cuid())
  trigger   String
  condition String?
  response  String
  priority  Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, priority])
}

model WhatsAppScheduled {
  id          String    @id @default(cuid())
  to          String
  message     String
  scheduledAt DateTime
  status      String    @default("pending")
  sentAt      DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model WhatsAppQueueItem {
  id                String    @id @default(cuid())
  phone             String
  payload           String
  status            String    @default("pending")
  retries           Int       @default(0)
  error             String?
  scheduledAt       DateTime?
  sentAt            DateTime?
  lastAttemptAt     DateTime?
  idempotencyKey    String?   @unique
  internalMessageId String?   @unique
  providerMessageId String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([status, scheduledAt])
  @@index([status, createdAt])
}

model WhatsAppLabel {
  id        String   @id @default(cuid())
  name      String   @unique
  color     String   @default("#3b82f6")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WhatsAppBlacklist {
  id        String   @id @default(cuid())
  phone     String   @unique
  reason    String?
  createdAt DateTime @default(now())
}

model WhatsAppWebhook {
  id        String   @id @default(cuid())
  name      String   @default("Webhook")
  url       String
  events    String
  secret    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WhatsAppFlowDefinition {
  id          String   @id @default(cuid())
  name        String
  trigger     String   @default("")
  category    String   @default("geral")
  description String?
  definition  String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([name, category])
}

model WhatsAppSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WhatsAppAnalytics {
  id             String   @id @default(cuid())
  date           DateTime @unique
  messagesSent   Int      @default(0)
  messagesRecv   Int      @default(0)
  uniqueContacts Int      @default(0)
  avgResponseMs  Int?
  metadata       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// ==========================================
// PRECIFICACAO ENTERPRISE (MULTI-UNIDADE)
// ==========================================

model Unidade {
  id              String   @id @default(cuid())
  codigo          String   @unique
  nome            String
  cidade          String?
  estado          String?
  timezone        String   @default("America/Sao_Paulo")
  moeda           String   @default("BRL")
  ativa           Boolean  @default(true)
  parentUnidadeId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  parentUnidade       Unidade?                    @relation("UnidadeHierarchy", fields: [parentUnidadeId], references: [id])
  filiais             Unidade[]                   @relation("UnidadeHierarchy")
  configuracoes       UnidadeConfiguracaoVersao[]
  doencas             UnidadeDoencaRegra[]
  regrasHoras         UnidadeRegraHora[]
  taxasPagamento      UnidadeTaxaPagamento[]
  minicustos          UnidadeMinicusto[]
  percentuaisComissao UnidadePercentualComissao[]
  descontos           UnidadeDescontoPreset[]
  contratos           UnidadeContratoTemplate[]
  simulacoes          OrcamentoSimulacao[]
  orcamentos          Orcamento[]
  audits              ConfigAuditLog[]
  systemLogs          SystemLog[]

  @@index([ativa])
}

model UnidadeConfiguracaoVersao {
  id                              String   @id @default(cuid())
  unidadeId                       String
  version                         Int
  isActive                        Boolean  @default(false)
  effectiveAt                     DateTime @default(now())
  effectiveFrom                   DateTime @default(now())
  effectiveTo                     DateTime?
  isDraft                         Boolean  @default(true)
  nome                            String?
  descricao                       String?
  createdBy                       String?
  baseCuidador12h                 Float
  baseAuxiliarEnf12h              Float
  baseTecnicoEnf12h               Float
  baseEnfermeiro12h               Float?
  margemPercent                   Float    @default(0)
  lucroFixo                       Float    @default(0)
  lucroFixoEscalaHoras            Boolean  @default(false)
  adicionalSegundoPacientePercent Float    @default(0)
  adicionalNoturnoPercent         Float    @default(0)
  adicionalFimSemanaPercent       Float    @default(0)
  adicionalFeriadoPercent         Float    @default(0)
  adicionalAltoRiscoPercent       Float    @default(0)
  adicionalAtPercent              Float    @default(0)
  adicionalAaPercent              Float    @default(0)
  adicionalAtEscalaHoras          Boolean  @default(true)
  adicionalAaEscalaHoras          Boolean  @default(true)
  impostoSobreComissaoPercent     Float    @default(0)
  aplicarTaxaAntesDesconto        Boolean  @default(false)
  createdAt                       DateTime @default(now())
  updatedAt                       DateTime @updatedAt

  unidade             Unidade                     @relation(fields: [unidadeId], references: [id], onDelete: Cascade)
  doencas             UnidadeDoencaRegra[]
  regrasHoras         UnidadeRegraHora[]
  taxasPagamento      UnidadeTaxaPagamento[]
  minicustos          UnidadeMinicusto[]
  percentuaisComissao UnidadePercentualComissao[]
  descontos           UnidadeDescontoPreset[]
  simulacoes          OrcamentoSimulacao[]
  orcamentos          Orcamento[]
  audits              ConfigAuditLog[]
  orcamentoAuditLogs  OrcamentoAuditLog[]

  @@unique([unidadeId, version])
  @@index([unidadeId, isActive])
  @@index([unidadeId, isActive, effectiveFrom, effectiveTo])
}

model UnidadeDoencaRegra {
  id                 String   @id @default(cuid())
  unidadeId          String
  configVersionId    String
  codigo             String
  nome               String
  complexidade       String
  profissionalMinimo String
  adicionalPercent   Float    @default(0)
  ativa              Boolean  @default(true)
  observacao         String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  unidade       Unidade                   @relation(fields: [unidadeId], references: [id], onDelete: Cascade)
  configVersion UnidadeConfiguracaoVersao @relation(fields: [configVersionId], references: [id], onDelete: Cascade)

  @@unique([configVersionId, codigo])
  @@index([unidadeId, ativa])
}

model UnidadeRegraHora {
  id              String   @id @default(cuid())
  unidadeId       String
  configVersionId String
  hora            Int
  fatorPercent    Float
  ativa           Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  unidade       Unidade                   @relation(fields: [unidadeId], references: [id], onDelete: Cascade)
  configVersion UnidadeConfiguracaoVersao @relation(fields: [configVersionId], references: [id], onDelete: Cascade)

  @@unique([configVersionId, hora])
  @@index([unidadeId, hora])
}

model UnidadeTaxaPagamento {
  id              String   @id @default(cuid())
  unidadeId       String
  configVersionId String
  metodo          String
  periodo         String
  taxaPercent     Float
  ativa           Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  unidade       Unidade                   @relation(fields: [unidadeId], references: [id], onDelete: Cascade)
  configVersion UnidadeConfiguracaoVersao @relation(fields: [configVersionId], references: [id], onDelete: Cascade)

  @@unique([configVersionId, metodo, periodo])
  @@index([unidadeId, metodo, periodo])
}

model UnidadeMinicusto {
  id                   String   @id @default(cuid())
  unidadeId            String
  configVersionId      String
  tipo                 String
  nome                 String
  valor                Float
  escalaHoras          Boolean  @default(false)
  ativoPadrao          Boolean  @default(true)
  opcionalNoFechamento Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  unidade       Unidade                   @relation(fields: [unidadeId], references: [id], onDelete: Cascade)
  configVersion UnidadeConfiguracaoVersao @relation(fields: [configVersionId], references: [id], onDelete: Cascade)

  @@unique([configVersionId, tipo])
  @@index([unidadeId, tipo])
}

model UnidadePercentualComissao {
  id              String   @id @default(cuid())
  unidadeId       String
  configVersionId String
  tipo            String
  nome            String
  percentual      Float
  ativo           Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  unidade       Unidade                   @relation(fields: [unidadeId], references: [id], onDelete: Cascade)
  configVersion UnidadeConfiguracaoVersao @relation(fields: [configVersionId], references: [id], onDelete: Cascade)

  @@unique([configVersionId, tipo])
  @@index([unidadeId, tipo])
}

model UnidadeDescontoPreset {
  id              String   @id @default(cuid())
  unidadeId       String
  configVersionId String
  nome            String
  etiqueta        String?
  percentual      Float
  ativo           Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  unidade       Unidade                   @relation(fields: [unidadeId], references: [id], onDelete: Cascade)
  configVersion UnidadeConfiguracaoVersao @relation(fields: [configVersionId], references: [id], onDelete: Cascade)

  @@unique([configVersionId, nome])
  @@index([unidadeId, ativo])
}

model UnidadeContratoTemplate {
  id           String    @id @default(cuid())
  unidadeId    String
  tipo         String
  nome         String
  versao       Int
  formato      String    @default("MARKDOWN")
  conteudo     String
  placeholders String?
  ativo        Boolean   @default(false)
  publicadoEm  DateTime?
  createdBy    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  unidade Unidade @relation(fields: [unidadeId], references: [id], onDelete: Cascade)

  @@unique([unidadeId, tipo, versao])
  @@index([unidadeId, tipo, ativo])
}

model OrcamentoSimulacao {
  id                    String   @id @default(cuid())
  unidadeId             String
  configVersionId       String
  orcamentoId           String?
  pacienteId            String?
  avaliacaoId           String?
  source                String   @default("ADMIN")
  status                String   @default("RASCUNHO")
  inputSnapshot         String
  outputSnapshot        String
  subtotal              Float?
  valorFinal            Float?
  descontoManualPercent Float?
  descontoPresetNome    String?
  minicustosDesativados String?
  inputHash             String?
  engineVersion         String?
  moeda                 String   @default("BRL")
  createdBy             String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  unidade       Unidade                   @relation(fields: [unidadeId], references: [id], onDelete: Cascade)
  configVersion UnidadeConfiguracaoVersao @relation(fields: [configVersionId], references: [id], onDelete: Cascade)
  orcamento     Orcamento?                @relation(fields: [orcamentoId], references: [id], onDelete: SetNull)
  paciente      Paciente?                 @relation(fields: [pacienteId], references: [id], onDelete: SetNull)
  avaliacao     Avaliacao?                @relation(fields: [avaliacaoId], references: [id], onDelete: SetNull)

  @@index([unidadeId, createdAt])
  @@index([configVersionId, createdAt])
  @@index([orcamentoId])
  @@index([pacienteId])
  @@index([avaliacaoId])
}

model ConfigAuditLog {
  id              String   @id @default(cuid())
  unidadeId       String
  configVersionId String?
  entidade        String
  entidadeId      String?
  acao            String
  beforeSnapshot  String?
  afterSnapshot   String?
  actorId         String?
  requestId       String?
  createdAt       DateTime @default(now())

  unidade       Unidade                    @relation(fields: [unidadeId], references: [id], onDelete: Cascade)
  configVersion UnidadeConfiguracaoVersao? @relation(fields: [configVersionId], references: [id], onDelete: SetNull)

  @@index([unidadeId, createdAt])
  @@index([configVersionId, createdAt])
  @@index([entidade, createdAt])
  @@index([requestId])
}

model OrcamentoAuditLog {
  id              String   @id @default(cuid())
  orcamentoId     String
  configVersionId String?
  acao            String
  status          String
  beforeSnapshot  String?
  afterSnapshot   String?
  diffSnapshot    String?
  inputHash       String?
  requestId       String?
  createdBy       String?
  createdAt       DateTime @default(now())

  orcamento     Orcamento                  @relation(fields: [orcamentoId], references: [id], onDelete: Cascade)
  configVersion UnidadeConfiguracaoVersao? @relation(fields: [configVersionId], references: [id], onDelete: SetNull)

  @@index([orcamentoId, createdAt])
  @@index([configVersionId, createdAt])
  @@index([acao, createdAt])
  @@index([status, createdAt])
  @@index([requestId])
}

// ==========================================
// LGPD — CONSENTIMENTO E COMPLIANCE
// ==========================================

model ConsentRecord {
  id            String    @id @default(cuid())
  subjectPhone  String
  tipo          String    // TERMS | MARKETING | DATA_PROCESSING | PROFILING
  consentido    Boolean
  versaoTermos  String    @default("1.0")
  ipAddress     String?
  userAgent     String?
  revokedAt     DateTime?
  createdAt     DateTime  @default(now())

  @@index([subjectPhone, tipo])
  @@index([subjectPhone, createdAt])
}

// ==========================================
// SISTEMA DE LOGS
// ==========================================

model SystemLog {
  id        String   @id @default(cuid())
  type      String // ERROR | INFO | WARNING | WHATSAPP | DEBUG
  action    String // Identificador da ação (ex: "avaliacao_criada")
  message   String // Descrição legível
  metadata  String? // JSON stringificado com dados contextuais
  stack     String? // Stack trace para erros
  userId    String? // Referência opcional ao usuário
  unidadeId String? // Unidade operacional associada ao evento
  requestId String? // Correlation/request id
  ipAddress String? // IP da requisição
  userAgent String? // Browser/Device info
  duration  Int? // Duração em ms (para performance)
  createdAt DateTime @default(now())

  unidade Unidade? @relation(fields: [unidadeId], references: [id])

  @@index([type])
  @@index([action])
  @@index([requestId])
  @@index([createdAt])
  @@index([type, createdAt])
  @@index([unidadeId, createdAt])
}
