# API Route Audit -- MAdef Project

**Date:** February 23, 2026
**Auditor:** Automated Code Audit
**Scope:** All 67 API route files under `src/app/api/`
**Focus:** Top 15 most critical endpoints (detailed) + full inventory (summary)

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [Scoring Methodology](#scoring-methodology)
3. [Detailed Endpoint Audits (Top 15)](#detailed-endpoint-audits)
   - [1. Auth NextAuth](#1-apiauthnextauthroutets)
   - [2. Health Check](#2-apihealthroutets)
   - [3. WhatsApp Webhook](#3-apiwhatsappwebhookroutets)
   - [4. Admin Pacientes (list/create)](#4-apiadminpacientesroutets)
   - [5. Admin Pacientes [id]](#5-apiadminpacientesidroutets)
   - [6. Admin Avaliacoes](#6-apiadminavaliacoesroutets)
   - [7. Admin Orcamentos (list/create)](#7-apiadminorcamentosroutets)
   - [8. Admin Orcamentos [id]](#8-apiadminorcamentosidroutets)
   - [9. Admin Candidatos](#9-apiadmincandidatosroutets)
   - [10. Admin Dashboard Stats](#10-apiadmindashboardstatsroutets)
   - [11. Admin WhatsApp Chat [phone]](#11-apiadminwhatsappchatphoneroutets)
   - [12. Admin WhatsApp Broadcast](#12-apiadminwhatsappbroadcastroutets)
   - [13. Admin Usuarios](#13-apiadminusuariosroutets)
   - [14. WhatsApp Status](#14-apiwhatsappstatusroutets)
   - [15. Orcamento (public calculator)](#15-apiorcamentoroutets)
4. [Score Summary Table](#score-summary-table)
5. [Full Endpoint Inventory (67 routes)](#full-endpoint-inventory)
6. [Recommendations](#recommendations)

---

## Executive Summary

The MAdef API layer consists of **67 route files** exposing endpoints for authentication, healthcare patient management, caregiver recruitment, pricing/budgeting, WhatsApp integration, and admin operations.

**Key Findings:**

| Metric | Value |
|--------|-------|
| Total route files | 67 |
| Fully protected (auth + capability) | 24 |
| Partially protected (auth only or webhook-signed) | 5 |
| Unprotected (no auth checks) | 38 |
| Using Zod validation | 3 of 15 critical |
| Using `withRequestContext` wrapper | 16 |
| Using rate limiting | 4 |
| Average score (top 15) | **5.5 / 10** |

**Critical risks identified:**

1. **38 unprotected routes** -- most admin endpoints under `/api/admin/` lack any authentication or authorization checks.
2. The WhatsApp broadcast endpoint has **no authentication** and can send messages to arbitrary phone numbers.
3. Multiple admin data-mutation routes accept raw `request.json()` without schema validation.
4. Only 4 endpoints enforce rate limiting.
5. Error responses on several unprotected routes leak internal error details (stack traces, Prisma messages).

---

## Scoring Methodology

Each endpoint is scored 0-10 across five dimensions (2 points each):

| Dimension | 2 pts | 1 pt | 0 pts |
|-----------|-------|------|-------|
| **Authentication** | `guardCapability` or equivalent session + role check | Session check only | None |
| **Input Validation** | Zod schema or thorough manual checks | Partial (only required fields) | No validation |
| **Error Handling** | try/catch + correct HTTP status codes + `withRequestContext` | try/catch + correct codes | Missing catches or wrong codes |
| **Query Efficiency** | Uses `select`/`include` with limits, pagination | Partial (includes but no limits) | No limits, fetches everything |
| **Security Hardening** | Rate limiting + output sanitization + no data leaks | One of the above | None |

---

## Detailed Endpoint Audits

---

### 1. `api/auth/[...nextauth]/route.ts`

**File:** `src/app/api/auth/[...nextauth]/route.ts`

**Functionality:**

| Property | Value |
|----------|-------|
| HTTP Methods | `GET`, `POST` |
| Purpose | NextAuth.js authentication handler (login, callback, session) |
| Request/Response | Delegated entirely to NextAuth `handlers` from `@/auth` |

The file is a 2-line passthrough that re-exports the `GET` and `POST` handlers generated by the NextAuth configuration in `@/auth`.

**Security Checklist:**

- [x] Authentication check -- Handled internally by NextAuth
- [x] Input validation -- Handled internally by NextAuth
- [x] Authorization -- N/A (this IS the auth endpoint)
- [ ] Rate limiting applied -- **No rate limiting on login attempts**
- [x] Output sanitization -- Handled by NextAuth

**Quality:**

- [x] Error handling -- Delegated to NextAuth
- [ ] Uses `withRequestContext` wrapper -- No
- [x] Efficient Prisma queries -- N/A
- [x] Proper TypeScript types -- Minimal but correct

**Score: 7/10**

**Recommendations:**
- Add rate limiting to prevent brute-force login attempts (e.g., max 10 attempts per minute per IP).
- Wrap with `withRequestContext` for request tracing.

---

### 2. `api/health/route.ts`

**File:** `src/app/api/health/route.ts`

**Functionality:**

| Property | Value |
|----------|-------|
| HTTP Methods | `GET` |
| Purpose | System health check -- database, filesystem, WhatsApp bridge, memory |
| Response | `HealthStatus` JSON with status `healthy`/`degraded`/`unhealthy`, subsystem checks, latency, DB schema validation |

Performs comprehensive health monitoring: database connectivity with latency measurement, file system checks for required files (`.env.local`, `prisma/dev.db`), WhatsApp bridge status via HTTP with fallback to local session file, and memory usage stats.

**Security Checklist:**

- [ ] Authentication check -- **None (publicly accessible)**
- [x] Input validation -- N/A (no input)
- [ ] Authorization -- **None**
- [ ] Rate limiting applied -- **No**
- [ ] Output sanitization -- **Exposes internal paths, DB provider, missing columns, memory usage**

**Quality:**

- [x] Error handling -- Multiple try/catch blocks, correct 200/503 status codes
- [ ] Uses `withRequestContext` wrapper -- No
- [x] Efficient Prisma queries -- Uses `SELECT 1` for ping
- [x] Proper TypeScript types -- Well-defined `HealthStatus` interface

**Score: 5/10**

**Recommendations:**
- **Critical:** The endpoint exposes sensitive infrastructure details (database provider, missing schema columns, file paths, memory stats). Either add authentication or reduce the publicly visible payload to `{ status, timestamp }`.
- Add rate limiting to prevent health-check abuse.
- Add `Cache-Control: no-store` is already present -- good.
- Consider a lightweight `/api/ping` for load balancers and restrict detailed health data to authenticated admins.

---

### 3. `api/whatsapp/webhook/route.ts`

**File:** `src/app/api/whatsapp/webhook/route.ts`

**Functionality:**

| Property | Value |
|----------|-------|
| HTTP Methods | `GET`, `POST` |
| Purpose | Receives incoming WhatsApp messages from the bridge service |
| Request | JSON body with message `key`, `remoteJid`, message content |
| Response | `{ ok: true, handled: 'conversation'|'legacy' }` or `{ ok: true, skipped: true }` |

The `POST` handler validates webhook signatures (HMAC), checks rate limits, validates origin headers, parses JSON, and delegates to either the conversation bot or legacy message handler. The `GET` handler returns a simple status check.

**Security Checklist:**

- [x] Authentication check -- HMAC webhook signature validation via `validateWebhookSecurity`
- [x] Input validation -- JSON parsing with type checks, `remoteJid` presence check
- [x] Authorization -- Origin validation via `ALLOWED_ORIGINS`
- [x] Rate limiting applied -- 100 requests/minute per IP
- [ ] Output sanitization -- Error messages may expose internal details

**Quality:**

- [x] Error handling -- Comprehensive try/catch, correct HTTP status codes (400, 403, 429, 500)
- [x] Uses `withRequestContext` wrapper -- Yes
- [x] Efficient Prisma queries -- No direct Prisma usage (delegated)
- [x] Proper TypeScript types -- Uses standardized `E` error codes and `ok`/`fail` helpers

**Score: 9/10**

**Recommendations:**
- Consider not including `rawCode` in error detail responses for production to avoid information leakage.
- The webhook secret is optional in development mode (`requireSecret: process.env.NODE_ENV !== 'development'`) -- ensure this cannot be exploited if `NODE_ENV` is misconfigured.

---

### 4. `api/admin/pacientes/route.ts`

**File:** `src/app/api/admin/pacientes/route.ts`

**Functionality:**

| Property | Value |
|----------|-------|
| HTTP Methods | `GET`, `POST` |
| Purpose | List patients with pagination/filtering; Create new patient |
| GET Request | Query params: `page`, `pageSize`, `sort`, `search`, `status`, `tipo`, `cidade` |
| GET Response | Paginated list with stats (total, ativos, leads, avaliacao) |
| POST Request | JSON body with `telefone` (required), `nome`, `cidade`, `bairro`, `tipo`, etc. |
| POST Response | `{ paciente }` with 201 status |

**Security Checklist:**

- [x] Authentication check -- `guardCapability('VIEW_PACIENTES')` / `guardCapability('MANAGE_PACIENTES')`
- [ ] Input validation -- **Partial** -- only checks `telefone` is non-empty; no Zod schema; no format validation
- [x] Authorization -- Capability-based (session + role + capability check)
- [ ] Rate limiting applied -- **No**
- [ ] Output sanitization -- Returns full Prisma objects

**Quality:**

- [x] Error handling -- try/catch with standardized `fail()` responses
- [x] Uses `withRequestContext` wrapper -- Yes
- [x] Efficient Prisma queries -- Pagination, `_count` select, parallel `Promise.all` for stats
- [ ] Proper TypeScript types -- Uses `any` for `where` clause

**Score: 7/10**

**Recommendations:**
- Add Zod schema validation for POST body (validate `telefone` format, enum values for `tipo`, `status`, `prioridade`).
- Replace `where: any` with a properly typed Prisma `where` input.
- Add rate limiting to prevent abuse of patient creation.
- Validate that `telefone` matches expected phone format before database lookup.

---

### 5. `api/admin/pacientes/[id]/route.ts`

**File:** `src/app/api/admin/pacientes/[id]/route.ts`

**Functionality:**

| Property | Value |
|----------|-------|
| HTTP Methods | `GET`, `PATCH` |
| Purpose | Retrieve single patient with full history; Update patient fields |
| GET Response | Patient with avaliacoes, orcamentos, alocacoes (with cuidador), mensagens (merged by ID + telefone), formSubmissions |
| PATCH Request | JSON body with partial patient fields |
| PATCH Response | `{ success: true, paciente }` with full includes |

**Security Checklist:**

- [ ] Authentication check -- **None**
- [ ] Input validation -- **None** -- PATCH accepts arbitrary body fields, no type or enum checking
- [ ] Authorization -- **None**
- [ ] Rate limiting applied -- **No**
- [ ] Output sanitization -- Returns full patient record with ALL messages, form submissions

**Quality:**

- [x] Error handling -- try/catch with 404/500 status codes
- [ ] Uses `withRequestContext` wrapper -- **No**
- [ ] Efficient Prisma queries -- **Problem:** fetches up to 100 messages, then does a second query for unlinked messages, combines in-memory, deduplicates with O(n^2) `findIndex`
- [ ] Proper TypeScript types -- Uses raw `NextResponse.json()` instead of standardized helpers

**Score: 2/10**

**Recommendations:**
- **Critical:** Add `guardCapability('VIEW_PACIENTES')` / `guardCapability('MANAGE_PACIENTES')` checks. This endpoint currently exposes patient medical data, messages, and form submissions to anyone.
- Add Zod validation for PATCH body -- restrict which fields can be updated and validate enum values.
- Wrap with `withRequestContext`.
- Use standardized `ok()` / `fail()` response helpers.
- Fix the O(n^2) deduplication: use a `Set` or `Map` instead of `findIndex`.
- Consider reducing message limit or adding pagination.
- Validate the `id` parameter format.

---

### 6. `api/admin/avaliacoes/route.ts`

**File:** `src/app/api/admin/avaliacoes/route.ts`

**Functionality:**

| Property | Value |
|----------|-------|
| HTTP Methods | `GET`, `POST` |
| Purpose | List clinical evaluations with pagination/filtering; Create new evaluation |
| GET Request | Query params: `page`, `pageSize`, `sort`, `search`, `status`, `tipo`, `createdFrom`, `createdTo` |
| GET Response | Paginated evaluations with patient info |
| POST Request | JSON body with `pacienteId` (required), scores (abemid, katz, lawton), levels, detailed data |
| POST Response | `{ avaliacao }` with 201 status |

**Security Checklist:**

- [x] Authentication check -- `guardCapability('VIEW_AVALIACOES')` / `guardCapability('MANAGE_AVALIACOES')`
- [ ] Input validation -- **Partial** -- only checks `pacienteId` is non-empty; no Zod for scores or enum values
- [x] Authorization -- Capability-based
- [ ] Rate limiting applied -- **No**
- [ ] Output sanitization -- Returns full Prisma objects

**Quality:**

- [x] Error handling -- try/catch with standardized `fail()` responses
- [x] Uses `withRequestContext` wrapper -- Yes
- [x] Efficient Prisma queries -- Uses `select` for patient fields, pagination, `Promise.all`
- [ ] Proper TypeScript types -- Uses `any` for `where`

**Score: 7/10**

**Recommendations:**
- Add Zod schema for POST body -- validate score ranges (0-100), enum values for `status`, `nivelSugerido`.
- Validate `pacienteId` exists before creation (foreign key errors are not user-friendly).
- Replace `where: any` with typed Prisma input.
- Date parsing for `createdFrom`/`createdTo` should validate format to prevent invalid date injection.

---

### 7. `api/admin/orcamentos/route.ts`

**File:** `src/app/api/admin/orcamentos/route.ts`

**Functionality:**

| Property | Value |
|----------|-------|
| HTTP Methods | `GET`, `POST` |
| Purpose | List budgets/quotes; Create new budget with pricing snapshots |
| GET Response | Last 100 orcamentos with patient info |
| POST Request | Validated via comprehensive `createOrcamentoSchema` Zod schema |
| POST Response | `{ success: true, data: orcamento, orcamento }` |

**Security Checklist:**

- [x] Authentication check -- `guardCapability('VIEW_ORCAMENTOS')` / `guardCapability('MANAGE_ORCAMENTOS')`
- [x] Input validation -- **Comprehensive Zod schema** with nested `snapshotsByScenario`, enum validation, min constraints
- [x] Authorization -- Capability-based
- [ ] Rate limiting applied -- **No**
- [ ] Output sanitization -- Returns full orcamento + paciente object

**Quality:**

- [x] Error handling -- try/catch, validation errors return 400 with Zod issues
- [ ] Uses `withRequestContext` wrapper -- **No** (uses raw `export async function`)
- [ ] Efficient Prisma queries -- GET fetches last 100 with no pagination; `include: { paciente: true }` pulls full patient object
- [x] Proper TypeScript types -- Well-defined Zod schemas, `ScenarioKey` type

**Score: 7/10**

**Recommendations:**
- Add pagination to GET endpoint (currently hard-limited to 100 records).
- Wrap handlers with `withRequestContext` for request tracing.
- Use `select` on paciente include to limit returned fields.
- Add rate limiting for POST.
- The response includes both `data` and `orcamento` keys with the same value -- remove duplication.
- Error detail in POST catch includes `error.message` which may leak Prisma internals.

---

### 8. `api/admin/orcamentos/[id]/route.ts`

**File:** `src/app/api/admin/orcamentos/[id]/route.ts`

**Functionality:**

| Property | Value |
|----------|-------|
| HTTP Methods | `GET`, `PATCH` |
| Purpose | Retrieve single budget; Update budget (status change, send proposal, approve, cancel) |
| PATCH Actions | `enviar` (queue WhatsApp proposal), `aceitar`, `aprovar`, `cancelar`, or generic field update |
| Side Effects | The `enviar` action enqueues a WhatsApp job AND immediately processes the outbox |

**Security Checklist:**

- [ ] Authentication check -- **None**
- [ ] Input validation -- **None** -- no Zod, no field validation, `parseFloat` on unvalidated input
- [ ] Authorization -- **None**
- [ ] Rate limiting applied -- **No**
- [ ] Output sanitization -- Exposes queue internals (worker state, queueItemId, providerMessageId)

**Quality:**

- [x] Error handling -- try/catch with 404/500 status codes
- [ ] Uses `withRequestContext` wrapper -- **No**
- [ ] Efficient Prisma queries -- `include: { paciente: true }` pulls full patient; double-fetches orcamento in `enviarProposta`
- [ ] Proper TypeScript types -- Uses `updateData: any`

**Score: 1/10**

**Recommendations:**
- **Critical:** Add `guardCapability('MANAGE_ORCAMENTOS')` -- this endpoint can trigger WhatsApp messages to patients without any authentication.
- **Critical:** Add Zod validation -- the `action` field determines business-critical state transitions with no validation.
- Validate `valorFinal` is a valid number before `parseFloat`.
- The `enviar` action calls `processWhatsAppOutboxOnce` synchronously -- this blocks the response. Consider making it async.
- Wrap with `withRequestContext`.
- Remove worker internals from the response payload.
- The spread pattern `...(body.cenarioEconomico && { ... })` will skip falsy values like `0` or empty strings -- use explicit `undefined` checks.

---

### 9. `api/admin/candidatos/route.ts`

**File:** `src/app/api/admin/candidatos/route.ts`

**Functionality:**

| Property | Value |
|----------|-------|
| HTTP Methods | `GET`, `POST` |
| Purpose | List caregiver candidates with filtering; Create new candidate |
| GET Request | Query params: `status`, `area`, `search` |
| GET Response | Candidates list + stats (total, aguardandoRH, emEntrevista, aprovados, rejeitados) |
| POST Request | JSON body with `telefone` (required), `nome`, `area`, `endereco`, `competencias` |
| POST Response | `{ success: true, cuidador }` |

**Security Checklist:**

- [ ] Authentication check -- **None**
- [ ] Input validation -- **Minimal** -- only checks `telefone` is truthy
- [ ] Authorization -- **None**
- [ ] Rate limiting applied -- **No**
- [ ] Output sanitization -- Returns full cuidador objects with message counts

**Quality:**

- [x] Error handling -- try/catch with 400/500 status codes
- [ ] Uses `withRequestContext` wrapper -- **No**
- [ ] Efficient Prisma queries -- GET runs 5 sequential `count()` queries instead of a single grouped count; hard-limit of 200 with no pagination
- [ ] Proper TypeScript types -- Uses `any` for `where`

**Score: 2/10**

**Recommendations:**
- **Critical:** Add authentication and authorization -- candidate data (phone numbers, addresses, competencies) is PII.
- Add Zod schema for POST body.
- Use `Promise.all` for the 5 parallel count queries (or use `groupBy`).
- Add pagination to GET.
- Wrap with `withRequestContext`.
- Validate `telefone` format.
- The duplicate check uses `findUnique` which returns a full object -- use `count` or `findFirst({ select: { id: true } })`.

---

### 10. `api/admin/dashboard/stats/route.ts`

**File:** `src/app/api/admin/dashboard/stats/route.ts`

**Functionality:**

| Property | Value |
|----------|-------|
| HTTP Methods | `GET` |
| Purpose | Aggregate dashboard statistics (leads, candidates, patients, evaluations, budgets, messages) |
| Response | Flat JSON with ~15 numeric stats |

Runs 15 parallel Prisma queries via `Promise.all` to compute real-time dashboard metrics.

**Security Checklist:**

- [ ] Authentication check -- **None**
- [ ] Input validation -- N/A (no input)
- [ ] Authorization -- **None**
- [ ] Rate limiting applied -- **No**
- [ ] Output sanitization -- Exposes internal business metrics

**Quality:**

- [x] Error handling -- try/catch with 500 status code
- [ ] Uses `withRequestContext` wrapper -- **No**
- [x] Efficient Prisma queries -- Uses `Promise.all` for parallel execution, `groupBy` for active conversations
- [ ] Proper TypeScript types -- Raw `NextResponse.json()`

**Score: 2/10**

**Recommendations:**
- **Critical:** Add authentication -- dashboard stats expose sensitive business intelligence (lead counts, revenue data, message volumes).
- Add caching (stats rarely need to be real-time; a 30-60 second cache would reduce DB load significantly).
- Wrap with `withRequestContext`.
- Consider using a materialized stats table updated via cron instead of 15 live queries.

---

### 11. `api/admin/whatsapp/chat/[phone]/route.ts`

**File:** `src/app/api/admin/whatsapp/chat/[phone]/route.ts`

**Functionality:**

| Property | Value |
|----------|-------|
| HTTP Methods | `GET`, `POST` |
| Purpose | GET: Retrieve chat history for a phone number. POST: Send a WhatsApp message to a contact |
| GET Response | Messages (up to 500), contact info (cuidador/paciente), flow state |
| POST Request | `{ message: string }` |
| POST Side Effects | Enqueues WhatsApp job, creates `mensagem` record, processes outbox, creates system log |

**Security Checklist:**

- [ ] Authentication check -- **None**
- [ ] Input validation -- **Minimal** -- POST only checks `message` is non-empty
- [ ] Authorization -- **None**
- [ ] Rate limiting applied -- **No**
- [ ] Output sanitization -- Exposes full message history, contact entity data, flow state, queue internals

**Quality:**

- [x] Error handling -- try/catch with 400/500 status codes, 202 for queued messages
- [ ] Uses `withRequestContext` wrapper -- **No**
- [ ] Efficient Prisma queries -- `contains` search on phone (no index-friendly `equals`); fetches 500 messages
- [ ] Proper TypeScript types -- Raw `NextResponse.json()`

**Score: 1/10**

**Recommendations:**
- **Critical:** Add authentication and authorization -- this endpoint allows anyone to read message histories and send WhatsApp messages to arbitrary phone numbers.
- Validate `phone` parameter format (e.g., must be digits, correct length).
- Add rate limiting -- especially on POST to prevent message spam.
- Use `equals` instead of `contains` for phone number lookup.
- Wrap with `withRequestContext`.
- The POST handler synchronously processes the outbox (`processWhatsAppOutboxOnce`), blocking the response. Make this async.
- Limit message count or add pagination.

---

### 12. `api/admin/whatsapp/broadcast/route.ts`

**File:** `src/app/api/admin/whatsapp/broadcast/route.ts`

**Functionality:**

| Property | Value |
|----------|-------|
| HTTP Methods | `POST` |
| Purpose | Send a WhatsApp message to multiple phone numbers simultaneously |
| Request | `{ phones: string[], message: string, campaignId?: string }` |
| Response | Campaign result with enqueued/failed counts, queue item IDs |
| Side Effects | Enqueues N WhatsApp jobs, processes outbox batch |

**Security Checklist:**

- [ ] Authentication check -- **None**
- [ ] Input validation -- **Partial** -- checks `phones` is non-empty array and `message` is non-empty
- [ ] Authorization -- **None**
- [ ] Rate limiting applied -- **No**
- [ ] Output sanitization -- Exposes per-phone queue details and worker internals

**Quality:**

- [x] Error handling -- try/catch with per-phone error collection
- [ ] Uses `withRequestContext` wrapper -- **No**
- [x] Efficient Prisma queries -- N/A (uses outbox service)
- [ ] Proper TypeScript types -- Raw `NextResponse.json()`

**Score: 1/10**

**Recommendations:**
- **Critical:** This is the most dangerous unprotected endpoint. Add `guardCapability('MANAGE_BROADCAST')` immediately. Without auth, anyone can use this to mass-send WhatsApp messages.
- Add rate limiting with strict per-IP and per-campaign limits.
- Add Zod validation for the request body.
- Validate phone number formats.
- Add maximum recipients limit per broadcast (e.g., 500).
- Consider making the broadcast asynchronous and returning a campaign tracking ID.
- Wrap with `withRequestContext`.

---

### 13. `api/admin/usuarios/route.ts`

**File:** `src/app/api/admin/usuarios/route.ts`

**Functionality:**

| Property | Value |
|----------|-------|
| HTTP Methods | `GET` |
| Purpose | List all users (pacientes + cuidadores) with their recent messages |
| Response | Combined, sorted array of patient and caregiver records with last 50 messages each |

Fetches ALL patients and ALL caregivers with their messages, combines them client-side, and sorts by creation date.

**Security Checklist:**

- [ ] Authentication check -- **None**
- [ ] Input validation -- N/A (no input)
- [ ] Authorization -- **None**
- [ ] Rate limiting applied -- **No**
- [ ] Output sanitization -- **Exposes ALL user data** including phone numbers, message content, status

**Quality:**

- [x] Error handling -- try/catch with 500 status code
- [ ] Uses `withRequestContext` wrapper -- **No**
- [ ] Efficient Prisma queries -- **Critical:** Fetches ALL records with no pagination or limits; includes 50 messages per entity; in-memory sort
- [ ] Proper TypeScript types -- Raw `NextResponse.json()`, leaks error `String(error)` in response

**Score: 1/10**

**Recommendations:**
- **Critical:** Add authentication -- this endpoint dumps the entire user database including PII and message content.
- **Critical:** Add pagination -- fetching all patients + all caregivers + 50 messages each will cause severe performance issues at scale.
- Remove `details: String(error)` from the error response -- this leaks internal error information.
- Add search/filter parameters.
- Wrap with `withRequestContext`.
- Use standardized response helpers.

---

### 14. `api/whatsapp/status/route.ts`

**File:** `src/app/api/whatsapp/status/route.ts`

**Functionality:**

| Property | Value |
|----------|-------|
| HTTP Methods | `GET` |
| Purpose | Check WhatsApp bridge connection status |
| Response | Connection status, QR code, connected phone number, bridge URL/port |

Falls back gracefully: first tries the bridge HTTP endpoint, then reads local session file, then returns disconnected status.

**Security Checklist:**

- [ ] Authentication check -- **None**
- [ ] Input validation -- N/A
- [ ] Authorization -- **None**
- [ ] Rate limiting applied -- **No**
- [ ] Output sanitization -- **Exposes bridge URL, port, QR code, connected phone number**

**Quality:**

- [x] Error handling -- Multi-level try/catch with graceful fallback
- [ ] Uses `withRequestContext` wrapper -- **No**
- [x] Efficient Prisma queries -- N/A
- [ ] Proper TypeScript types -- Uses `any` for payload/session

**Score: 2/10**

**Recommendations:**
- **Critical:** Add authentication -- this exposes the WhatsApp QR code (which allows account takeover) and internal bridge configuration.
- Add rate limiting.
- Remove `bridgeUrlResolved` and `bridgePortResolved` from public response -- these are internal infrastructure details.
- Replace `any` types with proper interfaces.
- Wrap with `withRequestContext`.

---

### 15. `api/orcamento/route.ts`

**File:** `src/app/api/orcamento/route.ts`

**Functionality:**

| Property | Value |
|----------|-------|
| HTTP Methods | `POST` |
| Purpose | Public pricing calculator -- supports both legacy and enterprise pricing engines |
| Request (Legacy) | `{ tipoProfissional, complexidade, horasDiarias, duracaoDias, ... }` |
| Request (Enterprise) | `{ planningInput: { recurrenceType, startDate, shiftType, ... }, unitId, contractType, paymentMethod, ... }` |
| Response | Detailed pricing breakdown with scheduling, costs, discounts, installments |
| Side Effects | Optionally persists orcamento to database when `persist: true` |

The most complex endpoint in the codebase. Routes between legacy and enterprise pricing engines based on input shape, with automatic fallback to legacy when enterprise schema is unavailable.

**Security Checklist:**

- [ ] Authentication check -- **None (public endpoint by design)**
- [x] Input validation -- **Comprehensive Zod schemas** (`LegacyOrcamentoSchema`, `PlanningInputSchema`, `EnterpriseSchema`)
- [ ] Authorization -- **None** -- `persist: true` allows unauthenticated database writes
- [x] Rate limiting applied -- 40 requests/minute per IP
- [ ] Output sanitization -- Returns detailed pricing internals (margins, tax, commission costs)

**Quality:**

- [x] Error handling -- ZodError handling with 400 + issues, generic 500 catch, enterprise fallback on schema mismatch
- [ ] Uses `withRequestContext` wrapper -- **No**
- [x] Efficient Prisma queries -- Uses `select: { id: true }` on persist
- [x] Proper TypeScript types -- Well-typed with Zod inference, mapped types

**Score: 6/10**

**Recommendations:**
- **High:** The `persist: true` + `pacienteId` option allows unauthenticated users to write orcamentos to the database. Either require authentication for persistence or remove this feature from the public endpoint.
- Consider reducing pricing detail in the response (gross margin, tax over margin, commission costs are business-sensitive).
- Wrap with `withRequestContext`.
- The Zod `.parse()` call (vs `.safeParse()`) for the enterprise schema throws on error -- this is caught by the outer try/catch, but `safeParse` would be more intentional.
- The fallback logic (`isEnterpriseSchemaMismatch`) catches based on error message string matching -- this is fragile.

---

## Score Summary Table

| # | Endpoint | Auth | Validation | Error Handling | Query Efficiency | Hardening | **Total** |
|---|----------|------|-----------|----------------|-----------------|-----------|-----------|
| 1 | `auth/[...nextauth]` | 2 | 2 | 1 | 2 | 0 | **7** |
| 2 | `health` | 0 | 2 | 2 | 2 | 0 | **5** |
| 3 | `whatsapp/webhook` | 2 | 2 | 2 | 2 | 2 | **9** |
| 4 | `admin/pacientes` | 2 | 1 | 2 | 2 | 0 | **7** |
| 5 | `admin/pacientes/[id]` | 0 | 0 | 1 | 0 | 0 | **2** |
| 6 | `admin/avaliacoes` | 2 | 1 | 2 | 2 | 0 | **7** |
| 7 | `admin/orcamentos` | 2 | 2 | 1 | 1 | 0 | **7** |
| 8 | `admin/orcamentos/[id]` | 0 | 0 | 1 | 0 | 0 | **1** |
| 9 | `admin/candidatos` | 0 | 0 | 1 | 0 | 0 | **2** |
| 10 | `admin/dashboard/stats` | 0 | 2 | 1 | 1 | 0 | **2** |
| 11 | `admin/whatsapp/chat/[phone]` | 0 | 0 | 1 | 0 | 0 | **1** |
| 12 | `admin/whatsapp/broadcast` | 0 | 1 | 1 | 1 | 0 | **1** |
| 13 | `admin/usuarios` | 0 | 2 | 1 | 0 | 0 | **1** |
| 14 | `whatsapp/status` | 0 | 2 | 2 | 2 | 0 | **2** |
| 15 | `orcamento` (public) | 0 | 2 | 2 | 2 | 1 | **6** |

**Average Score: 4.0 / 10**

---

## Full Endpoint Inventory

Total: **67 route files**

### Protected Endpoints (Authentication + Authorization via `guardCapability`)

These endpoints check session AND verify role-based capabilities.

| # | Route | Methods | Capability |
|---|-------|---------|------------|
| 1 | `/api/admin/pacientes` | GET, POST | `VIEW_PACIENTES`, `MANAGE_PACIENTES` |
| 2 | `/api/admin/avaliacoes` | GET, POST | `VIEW_AVALIACOES`, `MANAGE_AVALIACOES` |
| 3 | `/api/admin/avaliacoes/[id]/orcamento-preview` | GET | `VIEW_AVALIACOES` |
| 4 | `/api/admin/avaliacoes/[id]/preview-document` | POST | `SEND_PROPOSTA` / `SEND_CONTRATO` |
| 5 | `/api/admin/avaliacoes/[id]/send-proposta` | POST | `SEND_PROPOSTA` |
| 6 | `/api/admin/avaliacoes/[id]/send-contrato` | POST | `SEND_CONTRATO` |
| 7 | `/api/admin/orcamentos` | GET, POST | `VIEW_ORCAMENTOS`, `MANAGE_ORCAMENTOS` |
| 8 | `/api/admin/orcamentos/[id]/contrato` | POST | `MANAGE_ORCAMENTOS` |
| 9 | `/api/admin/orcamentos/[id]/recalculate` | POST | `MANAGE_ORCAMENTOS` |
| 10 | `/api/admin/contratos/templates` | GET, POST | `VIEW_ORCAMENTOS`, `MANAGE_ORCAMENTOS` |
| 11 | `/api/admin/contratos/render` | POST | `MANAGE_ORCAMENTOS` |
| 12 | `/api/admin/logs` | GET, DELETE | `VIEW_LOGS` |
| 13 | `/api/admin/logs/[id]` | GET | `VIEW_LOGS` |
| 14 | `/api/admin/relatorios/precificacao` | GET | `VIEW_ORCAMENTOS` |
| 15 | `/api/admin/whatsapp/queue/[id]/retry` | POST | `RETRY_QUEUE_ITEM` |
| 16 | `/api/admin/whatsapp/queue/[id]/cancel` | POST | `CANCEL_QUEUE_ITEM` |

### Partially Protected Endpoints (Session check only, or webhook-signed)

These endpoints verify the user is logged in but do not perform capability checks, or use an alternative security mechanism.

| # | Route | Methods | Protection Mechanism |
|---|-------|---------|---------------------|
| 1 | `/api/auth/[...nextauth]` | GET, POST | NextAuth internal session management |
| 2 | `/api/whatsapp/webhook` | GET, POST | HMAC signature + rate limit + origin check |
| 3 | `/api/admin/auth/me` | GET | Session check via `auth()` |
| 4 | `/api/admin/capabilities` | GET | Session check via `auth()` |
| 5 | `/api/admin/whatsapp/circuit-status` | GET | Session check via `auth()` |
| 6 | `/api/orcamento` | POST | Rate limiting (40/min per IP) only |

### Unprotected Endpoints (No authentication)

These endpoints have **no authentication or authorization checks** and are accessible to anyone.

| # | Route | Methods | Risk Level |
|---|-------|---------|-----------|
| 1 | `/api/admin/whatsapp/broadcast` | POST | **CRITICAL** -- mass WhatsApp messaging |
| 2 | `/api/admin/whatsapp/chat/[phone]` | GET, POST | **CRITICAL** -- read/send messages |
| 3 | `/api/admin/orcamentos/[id]` | GET, PATCH | **CRITICAL** -- trigger WhatsApp proposals |
| 4 | `/api/admin/pacientes/[id]` | GET, PATCH | **HIGH** -- patient PII and medical data |
| 5 | `/api/admin/candidatos` | GET, POST | **HIGH** -- caregiver PII |
| 6 | `/api/admin/candidatos/[id]` | GET, PATCH, DELETE | **HIGH** -- caregiver PII + deletion |
| 7 | `/api/admin/usuarios` | GET | **HIGH** -- dumps all users + messages |
| 8 | `/api/admin/dashboard/stats` | GET | **MEDIUM** -- business intelligence |
| 9 | `/api/admin/leads` | GET | **MEDIUM** -- lead data |
| 10 | `/api/admin/alocacoes` | GET, POST | **MEDIUM** -- allocation management |
| 11 | `/api/admin/alocacoes/[id]` | PATCH | **MEDIUM** -- allocation updates |
| 12 | `/api/admin/avaliacoes/[id]` | GET, PATCH, DELETE | **HIGH** -- evaluation data + deletion |
| 13 | `/api/admin/avaliacoes/reenviar-whatsapp` | POST | **HIGH** -- triggers WhatsApp send |
| 14 | `/api/admin/whatsapp/analytics` | GET | **MEDIUM** -- messaging analytics |
| 15 | `/api/admin/whatsapp/autoreplies` | GET, POST, PATCH, DELETE | **MEDIUM** -- auto-reply config |
| 16 | `/api/admin/whatsapp/blacklist` | GET, POST, DELETE | **MEDIUM** -- blacklist management |
| 17 | `/api/admin/whatsapp/contacts` | GET, POST | **MEDIUM** -- contact data |
| 18 | `/api/admin/whatsapp/export` | GET, POST | **HIGH** -- data export |
| 19 | `/api/admin/whatsapp/flow-definitions` | GET, POST, PATCH, DELETE | **MEDIUM** -- flow config |
| 20 | `/api/admin/whatsapp/flows` | GET, DELETE, PATCH | **MEDIUM** -- flow management |
| 21 | `/api/admin/whatsapp/labels` | GET, POST, PUT, DELETE | **LOW** -- label management |
| 22 | `/api/admin/whatsapp/quick-replies` | GET, POST, PUT, DELETE | **LOW** -- quick reply config |
| 23 | `/api/admin/whatsapp/queue` | GET, POST, PATCH | **MEDIUM** -- queue management |
| 24 | `/api/admin/whatsapp/queue/[id]` | GET, POST | **MEDIUM** -- queue item details |
| 25 | `/api/admin/whatsapp/scheduled` | GET, POST, DELETE | **MEDIUM** -- scheduled messages |
| 26 | `/api/admin/whatsapp/settings` | GET, PATCH, PUT | **HIGH** -- WhatsApp configuration |
| 27 | `/api/admin/whatsapp/templates` | GET, POST, PUT, DELETE | **MEDIUM** -- message templates |
| 28 | `/api/admin/whatsapp/webhooks` | GET, POST, PUT, PATCH, DELETE | **HIGH** -- webhook config |
| 29 | `/api/admin/usuarios/[telefone]/logs` | GET | **MEDIUM** -- per-user logs |
| 30 | `/api/admin/orcamentos/[id]/enviar-proposta` | POST | **HIGH** -- sends proposal via WhatsApp |
| 31 | `/api/admin/orcamentos/[id]/enviar-contrato` | POST | **HIGH** -- sends contract via WhatsApp |
| 32 | `/api/admin/orcamentos/[id]/gerar-proposta` | POST | **MEDIUM** -- generates proposal document |
| 33 | `/api/admin/orcamentos/[id]/gerar-contrato` | POST | **MEDIUM** -- generates contract document |
| 34 | `/api/admin/_debug/routes` | GET | **MEDIUM** -- debug route listing |
| 35 | `/api/health` | GET | **LOW** -- but leaks infra details |
| 36 | `/api/whatsapp/status` | GET | **MEDIUM** -- exposes QR code |
| 37 | `/api/whatsapp/connect` | POST | **CRITICAL** -- WhatsApp connection control |
| 38 | `/api/whatsapp/disconnect` | POST | **CRITICAL** -- WhatsApp disconnection |
| 39 | `/api/whatsapp/pair` | POST | **CRITICAL** -- pairing control |
| 40 | `/api/whatsapp/reset-auth` | POST | **CRITICAL** -- auth reset |
| 41 | `/api/whatsapp/messages` | GET | **HIGH** -- all messages |
| 42 | `/api/whatsapp/queue` | GET | **MEDIUM** -- queue status |
| 43 | `/api/whatsapp/data-dump` | GET | **CRITICAL** -- full data dump |
| 44 | `/api/alocacao/iniciar` | POST | **MEDIUM** -- allocation initiation |
| 45 | `/api/avaliacoes/hospital` | POST | **MEDIUM** -- hospital evaluation |
| 46 | `/api/pacientes/search` | GET | **HIGH** -- patient search |
| 47 | `/api/propostas/enviar` | POST | **HIGH** -- sends proposals |

---

## Recommendations

### Immediate (P0 -- Security Critical)

1. **Add authentication to all admin routes.** Create a middleware at `src/middleware.ts` that intercepts all `/api/admin/*` requests and verifies the session before the handler runs. This single change protects 47 endpoints.

2. **Add authentication to WhatsApp control routes.** The `/api/whatsapp/connect`, `/disconnect`, `/pair`, `/reset-auth`, and `/data-dump` endpoints allow complete WhatsApp account takeover without authentication.

3. **Protect the broadcast endpoint.** `/api/admin/whatsapp/broadcast` can send messages to arbitrary phone numbers -- add auth + rate limiting + recipient limit.

### Short-Term (P1 -- Data Protection)

4. **Add `guardCapability` to all routes that currently lack it.** Prioritize:
   - `admin/pacientes/[id]` -- patient medical records
   - `admin/orcamentos/[id]` -- can trigger WhatsApp sends
   - `admin/candidatos` -- caregiver PII
   - `admin/usuarios` -- full user dump
   - `admin/dashboard/stats` -- business intelligence

5. **Add Zod validation to all POST/PATCH endpoints.** Prioritize mutation endpoints that currently accept raw `request.json()`.

6. **Sanitize error responses.** Remove `String(error)`, `error.message`, and internal details from production error responses. Use the standardized `fail()` helper everywhere.

### Medium-Term (P2 -- Quality)

7. **Standardize all routes on `withRequestContext`.** Only 16 of 67 routes use it. This wrapper provides request tracing which is essential for debugging.

8. **Add rate limiting to all public-facing and mutation endpoints.** The `checkRateLimit` utility exists but is only used in 4 endpoints.

9. **Add pagination to all list endpoints.** Several endpoints (`admin/usuarios`, `admin/candidatos`, `admin/whatsapp/chat/[phone]`) fetch unbounded result sets.

10. **Replace `any` types with proper Prisma types** throughout the route handlers for type safety.

### Long-Term (P3 -- Architecture)

11. **Implement Next.js middleware for auth.** A single `middleware.ts` checking sessions on `/api/admin/*` routes would prevent all admin endpoint exposure.

12. **Add API versioning.** The current mix of legacy and enterprise pricing endpoints would benefit from explicit `v1`/`v2` versioning.

13. **Implement request logging and audit trail** for all data-mutation endpoints, especially those that trigger external communications.

14. **Add integration tests** for all authenticated endpoints to verify that unauthenticated requests are properly rejected.

---

*End of API Route Audit -- Generated February 23, 2026*
